- name: DNS VNFD
  shell: |
    cat > /etc/default/bind9 << EOF
    RESOLVCONF=no
    OPTIONS="-u bind -{{ iPAddressType[3] }}"
    EOF

- name: Restart service bind9
  systemd:
    state: restarted
    daemon_reload: yes
    name: bind9

- name: DNS VNFD
  shell: |
    cat > /etc/bind/named.conf.options << EOF
    acl "trusted" {
        {{ internalNetAddr }};
    EOF
        
- name: DNS VNFD
  shell: |
    cat >> /etc/bind/named.conf.options << EOF
        {{ item.value }};
    EOF
  with_dict: "{{ staticHosts }}"
  when: staticHosts is defined

- name: DNS VNFD
  shell: |
    cat >> /etc/bind/named.conf.options << EOF
    };
    options {
        directory "/var/cache/bind";
        recursion yes;
        allow-recursion { trusted; };
        listen-on { {{ internalNetAddr }}; };
        allow-transfer { none; };
        forwarders {
    EOF
    
- name: DNS VNFD
  shell: |
    cat >> /etc/bind/named.conf.options << EOF
            {{ item.value }};
    EOF
  with_dict: "{{ forwarders }}"
  when: forwarders is defined
  
- name: DNS VNFD
  shell: |
    cat >> /etc/bind/named.conf.options << EOF
        };
        dnssec-validation auto;
    };
    EOF

- name: DNS VNFD
  shell: |    
    cat >> /etc/bind/named.conf.local << EOF
    zone "{{ domainName }}" {
      type master;
      file "/etc/bind/zones/db.{{ domainName }}";
    };
    zone "{{ '.'.join(internalNetAddr.split('.')[:3][::-1]) }}.in-addr.arpa" {
      type master;
      file "/etc/bind/zones/db.{{ '.'.join(internalNetAddr.split('.')[:3][::-1]) }}";
    };
    EOF
    
- name: DNS VNFD
  shell: | 
    mkdir /etc/bind/zones
    cat > /etc/bind/zones/db.{{ domainName }} << EOF
    ;
    ; BIND data file for local loopback interface
    ;
    \$TTL 604800
    @ IN SOA cumulus.{{ domainName }}. admin.{{ domainName }}. (
      3 ; Serial
      604800 ; Refresh
      86400 ; Retry
      2419200 ; Expire
      604800 ) ; Negative Cache TTL
    ;
     IN NS cumulus.{{ domainName }}.
    cumulus.{{ domainName }}. IN A {{ internalNetAddr }}
    EOF
    
- name: DNS VNFD
  shell: | 
    mkdir /etc/bind/zones
    cat >> /etc/bind/zones/db.{{ domainName }} << EOF
    {{ item.key }}.{{ domainName }}. IN A {{ item.value }}
    EOF
  with_dict: "{{ staticHosts }}"
  when: staticHosts is defined
  
- name: DNS VNFD
  shell: | 
    cat > /etc/bind/zones/db.{{ '.'.join(internalNetAddr.split('.')[:3][::-1]) }} << EOF
    ;
    ; BIND reverse data file for local loopback interface
    ;
    \$TTL 604800
    @ IN SOA cumulus.{{ domainName }}. admin.{{ domainName }}. (
      3 ; Serial
      604800 ; Refresh
      86400 ; Retry
      2419200 ; Expire
      604800 ) ; Negative
    ; name servers
     IN NS cumulus.{{ domainName }}.
    ; PTR Records
    {{ internalNetAddr.split('.')[3] }} IN PTR cumulus.{{ domainName }}.
    EOF
    
- name: DNS VNFD
  shell: | 
    cat >> /etc/bind/zones/db.{{ '.'.join(internalNetAddr.split('.')[:3][::-1]) }} << EOF
    {{ item.value.split('.')[3] }} IN PTR {{ item.key }}.{{ domainName }}.
    EOF
  with_dict: "{{ staticHosts }}"
  when: staticHosts is defined

- name: DNS VNFD
  shell: | 
    named-checkconf
    named-checkzone {{ domainName }} /etc/bind/zones/db.{{ domainName }}
    named-checkzone {{ '.'.join(internalNetAddr.split('.')[:3][::-1]) }}.in-addr.arpa /etc/bind/zones/db.{{ '.'.join(internalNetAddr.split('.')[:3][::-1]) }}
  
- name: Restart service bind9
  systemd:
    state: restarted
    daemon_reload: yes
    name: bind9

